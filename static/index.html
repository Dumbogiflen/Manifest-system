<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Pilatus Manifest</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb; --ink:#0a1a2b; --muted:#667085; --brand:#0a4a86;
      --card:#fff; --border:#e5edf6; --accent:#0a84ff; --ok:#2ea44f; --warn:#f59e0b; --bad:#e74c3c;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Arial,sans-serif;}
    header{background:#003366;color:#fff;padding:12px 16px;font-weight:600}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1.3fr 1fr;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;background:#f0f6ff;color:var(--brand);font-size:16px}
    .body{padding:12px 14px}

    /* Chat */
    .chat{max-height:420px;overflow:auto;padding-right:6px}
    .bubble{max-width:68%;padding:8px 10px;margin:8px 0;border-radius:10px}
    .from-pilot{background:#eef2f7;color:#111;border-top-left-radius:4px}
    .from-me{background:#cce5ff;color:#001e3c;margin-left:auto;border-top-right-radius:4px}
    .row{display:flex;gap:8px;margin-top:10px}
    .row input, .row select{flex:1;padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    .row button{padding:8px 12px;border:none;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
    .meta{font-size:11px;color:#6b7280;margin-top:3px;text-align:right}
    .quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .quick button{background:#eef6ff;border:1px solid #bfdcff;border-radius:20px;padding:6px 10px;cursor:pointer}

    /* Lift */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:center}
    thead th{background:#f6faff;color:var(--brand)}
    .two{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .send{background:var(--ok)!important}
    .list{max-height:200px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .s-active{background:#e8fff3;color:#14532d;border:1px solid #d1fae5}
    .s-completed{background:#eef2ff;color:#1e3a8a;border:1px solid #dbeafe}
    .help{color:#c0392b;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
<header>Pilatus Manifest</header>
<main>

  <!-- Beskeder -->
  <section class="card">
    <h2>Beskeder til/fra pilot</h2>
    <div class="body">
      <div id="chat" class="chat"></div>
      <div class="row">
        <input id="msgInput" placeholder="Skriv en besked‚Ä¶" />
        <button id="sendBtn">Send</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
        <strong>Hurtigbeskeder</strong>
        <button id="addQuickBtn" style="background:#eee;color:#111;border:1px solid #ddd">+ tilf√∏j</button>
      </div>
      <div id="quick" class="quick"></div>
    </div>
  </section>

  <!-- Lift -->
  <section class="card">
    <h2>Opret lift</h2>
    <div class="body">
      <div class="two">
        <div>
          <label>Lift nr.</label>
          <input id="liftId" type="number" min="1" value="1" />
        </div>
        <div>
          <label>Navn</label>
          <input id="liftName" placeholder="(fx Lift 1 ‚Äì valgfrit)" />
        </div>
      </div>

      <table style="margin-top:10px">
        <thead>
          <tr><th>H√∏jde (m)</th><th>Springere</th><th>Overflyvninger</th></tr>
        </thead>
        <tbody id="liftRows"></tbody>
      </table>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Total springere</label>
          <input id="totalJumpers" type="number" min="0" placeholder="(tom = summer r√¶kker)" />
        </div>
        <div>
          <label>Total sk√¶rme</label>
          <input id="totalCanopies" type="number" min="0" placeholder="(tom = samme som springere)" />
        </div>
      </div>

      <div class="help" id="liftHelp"></div>

      <div class="row" style="margin-top:10px">
        <button id="sendLift" class="send">‚úàÔ∏è Send lift til pilot</button>
      </div>

      <h3 style="margin:16px 0 8px">Dagens lifts</h3>
      <div id="liftList" class="list"></div>
    </div>
  </section>

</main>

<script>
  // ---------- UI refs ----------
  const chatDiv  = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const sendBtn  = document.getElementById('sendBtn');
  const quickDiv = document.getElementById('quick');
  const addQuickBtn = document.getElementById('addQuickBtn');

  const liftRowsTbody = document.getElementById('liftRows');
  const liftHelp  = document.getElementById('liftHelp');
  const liftIdInp = document.getElementById('liftId');
  const liftName  = document.getElementById('liftName');
  const totalJumpers = document.getElementById('totalJumpers');
  const totalCanopies= document.getElementById('totalCanopies');
  const sendLiftBtn  = document.getElementById('sendLift');
  const liftListBox  = document.getElementById('liftList');

  const LS_LAST_LIFT_ID = 'manifest_last_lift_id';
  const FIXED_ALTS = [1000,1500,2250,4000];

  // Byg r√¶kker for de 4 h√∏jder
  function buildRows(){
    liftRowsTbody.innerHTML = '';
    FIXED_ALTS.forEach(alt=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${alt}</td>
        <td><input type="number" min="0" data-alt="${alt}" data-field="jumpers" placeholder="0" style="width:90%"></td>
        <td><input type="number" min="0" data-alt="${alt}" data-field="overflights" placeholder="(auto 1 hvis udfyldt)" style="width:90%"></td>
      `;
      liftRowsTbody.appendChild(tr);
    });
  }
  buildRows();

  // ---------- State fetch/render ----------
  async function load(){
    const res = await fetch('/api/state');
    const data = await res.json();
    renderChat(data.messages);
    renderQuick(data.quick);
    renderLiftList(data.lifts);
    proposeNextLiftId(data.lifts);
  }

  function renderChat(list){
    chatDiv.innerHTML = '';
    list.forEach(m=>{
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (m.sender==='manifest'?'from-me':'from-pilot');
      const statusTxt = m.status==='read'?'üëÅÔ∏è l√¶st':(m.status==='delivered'?'‚úÖ leveret':'‚úâÔ∏è sendt');
      bubble.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="meta">${statusTxt} ‚Ä¢ ${m.ts||''}</div>`;
      chatDiv.appendChild(bubble);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  function renderQuick(list){
    quickDiv.innerHTML = '';
    list.forEach(q=>{
      const b = document.createElement('button');
      b.textContent = q;
      b.onclick = async ()=>{
        await sendMessage(q);
      };
      quickDiv.appendChild(b);
    });
  }

  function renderLiftList(list){
    liftListBox.innerHTML = '';
    if (!list || !list.length){
      liftListBox.textContent = 'Ingen lifts oprettet i dag endnu.';
      return;
    }
    list.forEach(l=>{
      const div = document.createElement('div');
      const pill = `<span class="pill ${l.status==='completed'?'s-completed':'s-active'}">${l.status}</span>`;
      div.style.padding = '6px 4px';
      div.style.borderBottom = '1px solid #eee';
      div.innerHTML = `<strong>#${l.id}</strong> ${escapeHtml(l.name||('Lift '+l.id))} ${pill}`;
      liftListBox.appendChild(div);
    });
  }

  function proposeNextLiftId(list){
    let stored = parseInt(localStorage.getItem(LS_LAST_LIFT_ID)||'0',10);
    let maxId = stored;
    for (const l of (list||[])){
      if (typeof l.id==='number' && l.id > maxId) maxId = l.id;
    }
    // hvis input er tomt eller 1, foresl√• max+1
    const current = parseInt(liftIdInp.value||'0',10);
    if (!current || current <= maxId){
      liftIdInp.value = (maxId+1)||1;
    }
  }

  // ---------- Actions ----------
  async function sendMessage(text){
    const fd = new FormData();
    fd.append('text', text);
    await fetch('/api/messages', {method:'POST', body:fd});
    msgInput.value='';
    await load();
  }

  sendBtn.onclick = async ()=>{
    const t = msgInput.value.trim();
    if (!t) return;
    await sendMessage(t);
  };

  addQuickBtn.onclick = async ()=>{
    const t = prompt('Ny hurtigbesked:');
    if (!t) return;
    const fd = new FormData(); fd.append('text', t);
    await fetch('/api/quick/add', {method:'POST', body:fd});
    await load();
  };

  // Mark√©r pilot-beskeder som l√¶st, n√•r vinduet f√•r fokus
  window.addEventListener('focus', async ()=>{
    await fetch('/api/messages/read', {method:'POST'});
    await load();
  });

  sendLiftBtn.onclick = async ()=>{
    const id = parseInt(liftIdInp.value||'0',10);
    if (!id){ liftHelp.textContent='Angiv et gyldigt lift-nummer.'; return; }
    localStorage.setItem(LS_LAST_LIFT_ID, String(id));

    const rows = [];
    // saml r√¶kker, skip hvis jumpers tom/0
    FIXED_ALTS.forEach(alt=>{
      const j = valNum(`[data-alt="${alt}"][data-field="jumpers"]`);
      const o = valNum(`[data-alt="${alt}"][data-field="overflights"]`, null);
      if (j>0){
        rows.push({
          alt: alt,
          jumpers: j,
          overflights: (o===null ? 1 : o)  // auto 1 hvis udfyldt springere men ikke overflights
        });
      }
    });

    if (rows.length===0){
      liftHelp.textContent = 'Udfyld mindst √©n r√¶kke med springere.';
      return;
    }

    // totals
    const tJumpers  = valNum('#totalJumpers', null);
    const tCanopies = valNum('#totalCanopies', null);

    let sumJ = rows.reduce((a,r)=>a+(r.jumpers||0),0);
    const totals = {
      jumpers: (tJumpers===null ? sumJ : tJumpers),
      canopies: (tCanopies===null ? (tJumpers===null?sumJ:tJumpers) : tCanopies)
    };

    const name = (liftName.value||'').trim() || `Lift ${id}`;
    const obj = {
      id: id,
      name: name,
      status: "active",
      rows: rows,
      totals: totals
    };

    const fd = new FormData();
    fd.append('payload', JSON.stringify(obj));

    const res = await fetch('/api/lift/send',{method:'POST', body:fd});
    if (!res.ok){
      const err = await res.json().catch(()=>({error:'ukendt fejl'}));
      liftHelp.textContent = 'Fejl: ' + (err.error||'ukendt');
      return;
    }
    liftHelp.textContent = 'Lift sendt ‚úîÔ∏é';
    // foresl√• n√¶ste nummer
    liftIdInp.value = id+1;
    localStorage.setItem(LS_LAST_LIFT_ID, String(id+1));
    await load();
  };

  function valNum(sel, fallback=0){
    const el = document.querySelector(sel);
    if (!el) return fallback;
    const v = el.value.trim();
    if (v==='') return fallback;
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // init
  load();
  setInterval(load, 3000);
</script>
</body>
</html>
