<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Pilatus Manifest</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #eef2f7;
      margin: 0;
      padding: 0;
      color: #1e1e1e;
    }
    header {
      background-color: #004aad;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }
    .panel {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    h2 {
      color: #004aad;
      border-bottom: 2px solid #004aad33;
      padding-bottom: 6px;
    }
    textarea, input, select {
      width: 100%;
      border: 1px solid #ccd6e0;
      border-radius: 8px;
      padding: 8px;
      font-size: 14px;
      margin-top: 5px;
      resize: none;
    }
    button {
      background-color: #004aad;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }
    button:hover {
      background-color: #0060ff;
    }

    /* --- iPhone-style beskeder --- */
    #messages {
      display: flex;
      flex-direction: column;
      gap: 6px;
      height: 400px;
      overflow-y: auto;
      background: #f1f5fb;
      border-radius: 10px;
      padding: 10px;
    }
    .msg {
      display: inline-block;
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      word-wrap: break-word;
      font-size: 14px;
      position: relative;
    }
    .msg.manifest {
      background: #007aff;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .msg.pilot {
      background: #e5e5ea;
      color: black;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    .status {
      font-size: 10px;
      color: gray;
      text-align: right;
      margin-top: 2px;
    }

    /* --- Liftliste --- */
    .lift-item {
      border-bottom: 1px solid #eaeaea;
      padding: 8px 0;
    }
    .lift-item:last-child { border-bottom: none; }
    .lift-header {
      font-weight: bold;
      color: #004aad;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #666;
      padding: 10px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>Pilatus Manifest</header>

  <main>
    <div class="panel">
      <h2>Kommunikation</h2>
      <div id="messages"></div>
      <textarea id="msgText" rows="2" placeholder="Skriv besked til pilot..."></textarea>
      <button onclick="sendMsg()">Send</button>
    </div>

    <div class="panel">
      <h2>Liftplanlægning</h2>
      <label>Lift ID</label>
      <input id="liftId" type="number" placeholder="Fx 12">
      <label>Status</label>
      <select id="liftStatus">
        <option value="planned">Planlagt</option>
        <option value="boarding">Boarding</option>
        <option value="airborne">I luften</option>
        <option value="completed">Afsluttet</option>
      </select>
      <label>Springere (adskilt med komma)</label>
      <input id="liftJumpers" type="text" placeholder="Fx Peter, Lise, Mads">
      <button onclick="createLift()">Opret lift</button>

      <h3>Aktive lifts</h3>
      <div id="lifts"></div>
    </div>
  </main>

  <footer>Pilatus System – Manifest Kontrol</footer>

  <script>
    async function refresh() {
      try {
        const res = await fetch("/api/state");
        const data = await res.json();

        // --- Beskeder ---
        const msgDiv = document.getElementById("messages");
        msgDiv.innerHTML = data.messages.map(m => `
          <div class="msg ${m.sender}">
            ${m.text}
            <div class="status">${m.status || ""}</div>
          </div>
        `).join("");

        msgDiv.scrollTop = msgDiv.scrollHeight;

        // --- Lifts ---
        const liftDiv = document.getElementById("lifts");
        liftDiv.innerHTML = data.lifts.map(l => `
          <div class="lift-item">
            <div class="lift-header">Lift ${l.id} – ${l.status}</div>
            <div>Springere: ${(l.jumpers || []).join(", ")}</div>
          </div>
        `).join("");
      } catch (err) {
        console.warn("Kunne ikke hente data:", err);
      }
    }

    async function sendMsg() {
      const text = document.getElementById("msgText").value.trim();
      if (!text) return;
      const fd = new FormData();
      fd.append("text", text);
      await fetch("/api/messages", { method:"POST", body: fd });
      document.getElementById("msgText").value = "";
      refresh();
    }

    async function createLift() {
      const id = document.getElementById("liftId").value;
      const status = document.getElementById("liftStatus").value;
      const jumpers = document.getElementById("liftJumpers").value
                        .split(",").map(j => j.trim()).filter(j => j);
      if (!id) return alert("Indtast et lift ID!");

      const lift = { id: Number(id), status, jumpers };
      const fd = new FormData();
      fd.append("data", JSON.stringify(lift));
      await fetch("/api/lift/create", { method:"POST", body: fd });

      document.getElementById("liftId").value = "";
      document.getElementById("liftJumpers").value = "";
      refresh();
    }

    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>
